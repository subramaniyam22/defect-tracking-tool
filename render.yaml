# Render Blueprint - Defect Tracking Tool
# Deploy: Connect GitHub repo to Render and select "Blueprint"
# Render will auto-detect this file and create all services

databases:
  # PostgreSQL Database
  - name: defect-tracking-db
    plan: free # Use 'starter' for production
    databaseName: defect_tracking
    user: defect_user
    region: oregon
    postgresMajorVersion: 15

services:
  # Backend API (NestJS)
  - type: web
    name: defect-tracking-backend
    runtime: node
    region: oregon
    plan: free # Use 'starter' for production
    rootDir: backend
    buildCommand: npm install && npx prisma generate && npm run build
    startCommand: npx prisma migrate deploy && npm run start:prod
    healthCheckPath: /health
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: defect-tracking-db
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: FRONTEND_URL
        sync: false # Set manually after frontend deploys
      - key: ML_SERVICE_URL
        sync: false # Set manually after ML service deploys

  # ML Service (FastAPI)
  - type: web
    name: defect-tracking-ml
    runtime: python
    region: oregon
    plan: free # Use 'starter' for production
    rootDir: ml-service
    buildCommand: pip install --upgrade pip setuptools wheel && pip install -r requirements.txt
    startCommand: uvicorn main:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    autoDeploy: true
    envVars:
      - key: BACKEND_URL
        sync: false # Set manually after backend deploys
      - key: BACKEND_API_KEY
        generateValue: true

  # Frontend (Next.js)
  - type: web
    name: defect-tracking-frontend
    runtime: node
    region: oregon
    plan: free # Use 'starter' for production
    rootDir: frontend
    buildCommand: npm install && npm run build
    startCommand: npm start
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_API_URL
        sync: false # Set manually after backend deploys

